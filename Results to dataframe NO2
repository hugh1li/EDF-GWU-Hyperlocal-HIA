library(raster)
library(rgdal)
library(glue)
library(dplyr)
library(Rcpp)

#Set rasters for Clip
setwd('/home/vtinney/run/clip/')
bay <- readOGR(dsn=getwd(), layer='cvdmort_county_25_99')
ala <- readOGR(dsn=getwd(), layer='alameda')
oak <- readOGR(dsn=getwd(), layer='LandScangrid_AQ2')

#====================================================================
 PAF BAY CVD - done
setwd('/home/vtinney/run/results/no2/cvd.mort/paf/bay/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/cvd.mort/paf/bay/crop/'
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    		r <-raster(files[i])
    		rc <- mask(r, bay)
    		rc <- writeRaster(rc, outfiles[i])
    		print(files[i])
	}

setwd('/home/vtinney/run/results/no2/cvd.mort/paf/bay/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p ==0] <- NA
setwd('/home/vtinney/run/results/no2/cvd.mort/df/')
	bay.sum <- colSums(p, na.rm=TRUE)
	bay.mean <- apply(p,2,mean,na.rm=TRUE)
	bay.iqr <- apply(p,2,quantile,na.rm=TRUE)
	bay.paf <- rbind(bay.sum, bay.mean, bay.iqr)
	write.csv(bay.paf, 'paf.sum.bay.csv')

#====================================================================
# BAY ASTHMA ER
setwd('/home/vtinney/run/results/no2/asthma.er/paf/bay/')
	files <- paste(list.files(pattern = "\\.tif*", full.names=TRUE))

	outpath <- '/home/vtinney/run/results/no2/asthma.er/paf/bay/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    		r <-raster(files[i])
    		rc <- mask(r, bay)
    		rc <- writeRaster(rc, outfiles[i])
    		print(files[i])
	}

setwd('/home/vtinney/run/results/no2/asthma.er/paf/bay/crop/')
	files <- paste(list.files(pattern = "\\.tif*", full.names=TRUE))
	p <- stack(files)
	p <- as.data.frame(p)
	p[p ==0] <- NA
setwd('/home/vtinney/run/results/no2/asthma.er/df/')
	bay.sum <- colSums(p, na.rm=TRUE)
	bay.mean <- apply(p,2,mean,na.rm=TRUE)
	bay.iqr <- apply(p,2,quantile,na.rm=TRUE)
	bay.paf <- rbind(bay.sum, bay.mean, bay.iqr)
	write.csv(bay.paf, 'paf.sum.bay.csv')

#====================================================================
# BAY ASTHMA INC
setwd('/home/vtinney/run/results/no2/asthma.inc/paf/bay/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/asthma.inc/paf/bay/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    		r <-raster(files[i])
    		rc <- mask(r, bay)
    		rc <- writeRaster(rc, outfiles[i])
    		print(files[i])
	}

setwd('/home/vtinney/run/results/no2/asthma.inc/paf/bay/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)	
	p <- as.data.frame(p)
	p[p ==0] <- NA
setwd('/home/vtinney/run/results/no2/asthma.inc/df/')
	bay.sum <- colSums(p, na.rm=TRUE)
	bay.mean <- apply(p,2,mean,na.rm=TRUE)
	bay.iqr <- apply(p,2,quantile,na.rm=TRUE)
	bay.paf <- rbind(bay.sum, bay.mean, bay.iqr)
	write.csv(bay.paf, 'paf.sum.bay.csv')

#====================================================================
# PAF ALAMEDA CVD MORT
setwd('/home/vtinney/run/results/no2/cvd.mort/paf/alameda/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/cvd.mort/paf/alameda/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    		r <-raster(files[i])
		rc <- crop(r, ala)
    		rc <- mask(r, ala)
    		rc <- writeRaster(rc, outfiles[i])
    		print(files[i])
	}

setwd('/home/vtinney/run/results/no2/cvd.mort/paf/alameda/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA
setwd('/home/vtinney/run/results/no2/cvd.mort/df/')
	ala.sum <- colSums(p, na.rm=TRUE)
	ala.mean <- colMeans(p, na.rm=TRUE)
	ala.iqr <- apply(p,2,quantile,na.rm=TRUE)
	ala.paf <- rbind(ala.sum, ala.mean, ala.iqr)
	write.csv(ala.paf, 'paf.sum.ala.csv')


#====================================================================
# ALAMEDA ASTHMA ER
setwd('/home/vtinney/run/results/no2/asthma.er/paf/alameda/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/asthma.er/paf/alameda/crop/'
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    	r <-raster(files[i])
    	rc <- crop(r, ala)
    	rc <- mask(r, ala)
	rc <- writeRaster(rc, outfiles[i])
	print(files[i])
	}
setwd('/home/vtinney/run/results/no2/asthma.er/paf/alameda/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA
setwd('/home/vtinney/run/results/no2/asthma.er/df/')
	ala.sum <- colSums(p, na.rm=TRUE)
	ala.mean <- colMeans(p, na.rm=TRUE)
	ala.iqr <- apply(p,2,quantile,na.rm=TRUE)
	ala.paf <- rbind(ala.sum, ala.mean, ala.iqr)
	write.csv(ala.paf, 'paf.sum.ala.csv')


#====================================================================
# ALAMEDA ASTHMA INC
setwd('/home/vtinney/run/results/no2/asthma.inc/paf/alameda/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/asthma.inc/paf/alameda/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    	r <-raster(files[i])
    	rc <- crop(r, ala)
    	rc <- mask(r, ala)
	rc <- writeRaster(rc, outfiles[i])
	print(files[i])
	}
setwd('/home/vtinney/run/results/no2/asthma.inc/paf/alameda/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA
setwd('/home/vtinney/run/results/no2/asthma.inc/df/')
	ala.sum <- colSums(p, na.rm=TRUE)
	ala.mean <- colMeans(p, na.rm=TRUE)
	ala.iqr <- apply(p,2,quantile,na.rm=TRUE)
	ala.paf <- rbind(ala.sum, ala.mean, ala.iqr)
	write.csv(ala.paf, 'paf.sum.ala.csv')

#====================================================================
# PAF OAK CVD MORT - running
setwd('/home/vtinney/run/results/no2/cvd.mort/paf/oak/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	
	outpath <- '/home/vtinney/run/results/no2/cvd.mort/paf/oak/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    	r <-raster(files[i])
    	rc <- crop(r, oak)
    	rc <- mask(r, oak)
	rc <- writeRaster(rc, outfiles[i], overwrite=TRUE)
	print(files[i])
	}

setwd('/home/vtinney/run/results/no2/cvd.mort/paf/oak/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA
setwd('/home/vtinney/run/results/no2/cvd.mort/df/')
	oak.sum <- colSums(p, na.rm=TRUE)
	oak.mean <- colMeans(p, na.rm=TRUE)
	oak.iqr <- apply(p,2,quantile,na.rm=TRUE)
	oak.paf <- rbind(oak.sum, oak.mean, oak.iqr)
	write.csv(oak.paf, 'paf.sum.oak.csv')

#====================================================================
# OAK ASTHMA ER
setwd('/home/vtinney/run/results/no2/asthma.er/paf/oak/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/asthma.er/paf/oak/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    	r <-raster(files[i])
    	rc <- crop(r, oak)
    	rc <- mask(r, oak)
	rc <- writeRaster(rc, outfiles[i], overwrite=TRUE)
	print(files[i])
	}

setwd('/home/vtinney/run/results/no2/asthma.er/paf/oak/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA

setwd('/home/vtinney/run/results/no2/asthma.er/df/')
	oak.sum <- colSums(p, na.rm=TRUE)
	oak.mean <- colMeans(p, na.rm=TRUE)
	oak.iqr <- apply(p,2,quantile,na.rm=TRUE)
	oak.paf <- rbind(oak.sum, oak.mean, oak.iqr)
	write.csv(oak.paf, 'paf.sum.oak.csv')

#====================================================================
# OAK ASTHMA INC
setwd('/home/vtinney/run/results/no2/asthma.inc/paf/oak/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)

	outpath <- '/home/vtinney/run/results/no2/asthma.inc/paf/oak/crop/'
	dir.create(outpath)
	outfiles <- paste0(outpath, files)

	for(i in 1:length(files)) {
    	r <-raster(files[i])
    	rc <- crop(r, oak)
    	rc <- mask(r, oak)
	rc <- writeRaster(rc, outfiles[i], overwrite=TRUE)
	print(files[i])
	}

setwd('/home/vtinney/run/results/no2/asthma.inc/paf/oak/crop/')
	files <- list.files(pattern = "\\.tif*", full.names=TRUE)
	p <- stack(files)
	p <- as.data.frame(p)
	p[p == 0] <- NA
setwd('/home/vtinney/run/results/no2/asthma.inc/df/')
	oak.sum <- colSums(p, na.rm=TRUE)
	oak.mean <- colMeans(p, na.rm=TRUE)
	oak.iqr <- apply(p,2,quantile,na.rm=TRUE)
	oak.paf <- rbind(oak.sum, oak.mean, oak.iqr)
	write.csv(oak.paf, 'paf.sum.oak.csv')

