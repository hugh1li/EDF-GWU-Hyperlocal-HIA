# Validate results received from HIA for PM all cause

library(raster)
library(rgdal)

setwd('/home/vtinney/run/results/pm/all.cause/paf/bay/')

# Load in the results file. In this case, going to test the results for all ages, using county rate, 
# average PM values for 2015-2016, using the Krewski 2009 beta, and Night time all ages population

	test <- raster('bay.paf.krew.all.point.co.all.ls.night.pm.mean.15.16.tif')

# Now read in all the underlying calculating files. 
	setwd('/home/vtinney/run/')
	pop <- raster('pop/bay.pop.ls.night.tif') # all ages night time population
	rate <- raster('rates/mortality.co.all.tif') # mortality rate all ages, county
	beta <- raster('betas/pm/beta.krew.all.point.tif') # krewski beta. I made a file where each grid cell has the beta value. 
							   # This is not necessary, but I found it easier to do this for the overlay calculation.
	conc <- raster('conc/conc.pm.mean.15.16.tif')	   # Mean harvard PM dataset for 2015-2016.


# Since there are so many cells with values 0, I do a random selection of 10 grid cells, so that
# at least I get one where the values are not 0.

z <- sampleRandom(test, size=10, na.rm=TRUE, xy=TRUE, rowcol=TRUE)

#Results of the random sample
z
#       row  col         x        y
# [1,]  273 1745 -122.1787 38.63792
# [2,] 2179 2712 -121.3729 37.04958
# [3,]  966  840 -122.9329 38.06042
# [4,]   71  359 -123.3338 38.80625
# [5,]  309 1789 -122.1421 38.60792
# [6,] 2145 2319 -121.7004 37.07792
# [7,]  595 1199 -122.6337 38.36958
# [8,] 1174 1734 -122.1879 37.88708
# [9,]  963 2010 -121.9579 38.06292
#[10,]  727 1177 -122.6521 38.25958
#      bay.paf.krew.all.point.co.all.ls.night.pm.mean.15.16
# [1,]                                         0.0000000000
# [2,]                                         0.0000000000
# [3,]                                         0.0000000000
# [4,]                                         0.0000000000
# [5,]                                         0.0000000000
# [6,]                                         0.0000000000
# [7,]                                         0.0000000000
# [8,]                                         0.0007325615
# [9,]                                         0.0000000000

# Row 8 from the above shows a non-zero value, so use that one. 
# Row 8 is the row 1174, and column 1734.

# Stack the underlying files
r <- stack(pop, rate, beta, conc)

# Take the row 1174 and colmn 1734 of the raster input stack.
r[1174, 1734]


#     bay.pop.ls.night mortality.co.all beta.krew.all.point conc.pm.mean.15.16
#[1,]                3            67.95         0.005826891           6.280864

# Manually calculate using the input files to see if the values are the same.

t <- 3*67.95*(10^-4)*(1-exp(-0.005826891*6.280864))
t
#[1] 0.0007325615 
#They are the same
